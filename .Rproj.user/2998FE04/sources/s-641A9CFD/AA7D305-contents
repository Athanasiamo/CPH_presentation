library(tidyverse)
library(mgcv)

load("~/LCBC/Projects/Cross_projects/MOAS/data/MOAS.RData")

dat <- MOAS %>% 
  MOAS::filter_site() %>% 
  MOAS::filter_trainingexposed(grepl("post", NCP_Condition)) %>% 
  select(CrossProject_ID, Age, CVLT_30min_Free,
         MRI_aseg_left_hippocampus,
         MRI_aseg_right_hippocampus) %>% 
  mutate(
    Hippocampus = MRI_aseg_left_hippocampus + MRI_aseg_right_hippocampus
  ) %>% 
  select(-MRI_aseg_right_hippocampus, -MRI_aseg_left_hippocampus) %>% 
  na.omit() %>% 
  arrange(CrossProject_ID, Age) %>% 
  group_by(CrossProject_ID) %>% 
  mutate(
    TPs = n(),
    BL_Age = min(Age),
    Interval = Age - BL_Age
  ) %>% 
  ungroup()

fit <- gamm(Hippocampus ~ s(Age), 
            data = dat, random = list(CrossProject_ID =~ 1))
plot(fit$gam)

# Save random effects
random_effects <- ranef(fit$lme)$CrossProject_ID$`(Intercept)`

# Standard deviation of noise
sd_epsilon <- sd(residuals(fit$lme))

# BL age distribution
bl_age_distribution <- dat %>% 
  distinct(CrossProject_ID, BL_Age) %>% 
  pull(BL_Age)

# Interval distributions
interval_distributions <- dat %>% 
  group_by(CrossProject_ID) %>% 
  summarise(ints = list(Interval)) %>% 
  pull(ints)

# Cogdata distribution
cog_dist <- dat %>% 
  group_by(CrossProject_ID) %>% 
  summarise(ints = list(CVLT_30min_Free)) %>% 
  pull(ints)


# Simulate data
# Unique IDs
n <- 1000

sim_data <- tibble(
  ID = seq(1, n, by = 1),
  random_intercept = sample(random_effects, size = n),
  BL_Age = sample(bl_age_distribution, size = n),
  Interval = interval_distributions[sample(1:length(interval_distributions), size = n)]
) %>% 
  unnest(cols = Interval) %>% 
  mutate(Age = BL_Age + Interval) %>% 
  mutate(
    Hippocampus = predict(fit$gam, newdata = .) + random_intercept + rnorm(nrow(.), sd = sd_epsilon),
    Hippocampus = as.numeric(Hippocampus),
    Age_group = cut(Age, seq(0, 100, by=10))
         )

# Plot it ----
sim_data %>% 
  ggplot(aes(x = Age, y = Hippocampus)) + 
  geom_line(aes(group = ID)) + 
  geom_point() +
  geom_smooth()


# Save it ----
save(sim_data, file = paste0(here::here("data/"), "sim_data.rda"), compress = "xz")
